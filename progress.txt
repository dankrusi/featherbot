# FeatherBot Progress Log
Started: 2026-02-08
Milestone: M17 - Sub-agents
---

## Codebase Patterns
- Indentation: tabs (biome enforced)
- Double quotes, semicolons (biome javascript formatter)
- ESM throughout (`"type": "module"`)
- tsconfig uses `module: "Node16"` / `moduleResolution: "Node16"`
- turbo tasks: build, typecheck, lint, test
- Node engine: >=20 (machine has v20.18.0)
- pnpm v9.15.9
- Package scripts: `build` (tsup), `typecheck` (tsc --noEmit), `lint` (biome check src/), `test` (vitest run --passWithNoTests)
- Package tsconfig extends root: `{ "extends": "../../tsconfig.json" }`
- .turbo/ directories added to .gitignore
- Imports use `.js` extension for ESM (e.g., `from "./config/schema.js"`)
- Zod schemas use `.default({})` on nested objects for full defaults cascading
- Biome forbids `!` non-null assertions — use `=== undefined` checks instead
- Biome collapses function params to one line when they fit within lineWidth (100)
- `biome-ignore lint/suspicious/noExplicitAny: reason` for necessary any casts at SDK boundaries
- Biome import sorting: `type` imports sort alphabetically by path, not grouped separately
- `biome-ignore` comments must be on the line directly above the offending line
- Biome breaks long `export { ... }` statements across multiple lines when they exceed lineWidth
- Biome `noUnusedTemplateLiteral`: use regular strings not template literals when no interpolation
- `better-sqlite3` default import: `import Database from "better-sqlite3"`, type is `Database.Database`
- Array element access needs optional chaining or a defined check for TypeScript strict mode
- Biome collapses union types onto one line when they fit within lineWidth
- `workspace:*` dependency with `Node16` moduleResolution requires the dependent package to have `dist/` built
- Biome collapses short ternaries, method chains onto one line when they fit within lineWidth
- Biome sorts imports alphabetically by module path
- Commander command registration pattern: extract `registerXxx(cmd: Command)` functions in separate files
- tsup multi-entry: `tsup src/index.ts src/bin.ts --format esm --dts` for CLI packages
- readline/promises tests: use PassThrough streams with delayed line feeding
- Tests run from `packages/<pkg>/` as cwd — use `resolve(process.cwd(), "..", "..", ...)` to reach repo root
- Biome sorts named imports alphabetically within `{ }` blocks
- Skill directory name != frontmatter `name` — use `skill.path` for file lookups
- `yaml` npm package for YAML frontmatter parsing
- `croner` Cron class: `new Cron(expr, { timezone }).nextRun()` returns `Date | null`
- croner uses system local timezone by default — always pass `timezone: "UTC"` in tests
- Zod discriminated union requires kind-narrowing before accessing variant-specific fields
- `createAgentLoop` accepts optional `toolRegistry` param so gateway can pre-populate tools
- Biome wraps function arguments when they're inside another function call and exceed lineWidth
- vi.useFakeTimers() + vi.advanceTimersByTimeAsync() for timer tests
- CronService pattern: start after channels, stop before channels on shutdown
- HeartbeatService pattern: same start/stop lifecycle as CronService in gateway
- When adding new config fields, must `pnpm --filter @featherbot/core build` before CLI can typecheck
- Biome collapses short import lists to one line (even 3 named imports if they fit in lineWidth)
- TypeScript strict: `let resolveFirst: (() => void) | undefined` for Promise resolve callbacks
- grammy mock pattern: vi.mock("grammy"), capture `on()` handlers in a Map, mock api.sendMessage
- Biome forbids `!` non-null assertions in test files too — use `?.()` optional chain calls
- Baileys v7: `vi.hoisted()` required for mock variables used in `vi.mock()` factory (factory is hoisted above declarations)
- CronTool pattern: thin tool wrapper around a service class, constructor-injected dependency
- SpawnTool follows CronTool pattern: constructor accepts SubagentManager + mutable originContext
- SubagentManager: own AgentLoop instances (not reuse main), reduced tool set (5 tools only)
- Mutable origin context pattern: gateway subscribes to `message:inbound` to update context before adapter processes
- vi.waitFor() for async sub-agent completion assertions (avoids manual timers for fast tasks)

---

### US-001 - Sub-agent Types & Config Schema (DONE)
**Files modified:**
- packages/core/src/agent/subagent-types.ts (created)
- packages/core/src/config/schema.ts (SubagentConfigSchema added)
- packages/core/src/agent/index.ts (exports)
- packages/core/src/index.ts (exports)

**Learnings:**
- SubagentConfigSchema: maxIterations 15, timeoutMs 300000
- Type-only exports go in separate `export type { ... }` block per biome conventions

---

### US-002 - SubagentManager Core Implementation (DONE)
**Files modified:**
- packages/core/src/agent/subagent.ts (created)
- packages/core/src/agent/index.ts (export SubagentManager)
- packages/core/src/index.ts (export SubagentManager)

**Learnings:**
- SubagentManager creates own AgentLoop per spawn (fresh session, reduced tools)
- Promise.race for timeout: `new Promise<never>((_, reject) => setTimeout(reject, ms))`
- Reduced tool set: exec, read_file, write_file, edit_file, list_dir only

---

### US-003 - SubagentManager Tests (DONE)
**Files modified:**
- packages/core/src/agent/subagent.test.ts (created, 10 tests)

**Learnings:**
- vi.waitFor() is better than manual delays for async completion tests
- vi.useFakeTimers() + vi.advanceTimersByTimeAsync() for timeout tests
- Mock provider with `() => new Promise(() => {})` for never-resolving LLM

---

### US-004 - SpawnTool Implementation (DONE)
**Files modified:**
- packages/core/src/tools/spawn-tool.ts (created)
- packages/core/src/tools/index.ts (exports)
- packages/core/src/index.ts (exports)

**Learnings:**
- SpawnTool + SubagentStatusTool in same file
- Biome wraps long template literal pushes across lines

---

### US-005 - SpawnTool Tests (DONE)
**Files modified:**
- packages/core/src/tools/spawn-tool.test.ts (created, 7 tests)

**Learnings:**
- Mock SubagentManager as plain object with vi.fn() methods, cast via `as unknown as SubagentManager`

---

### US-006 - Gateway Integration (DONE)
**Files modified:**
- packages/cli/src/commands/gateway.ts

**Learnings:**
- Must `pnpm --filter @featherbot/core build` before CLI can import new core exports
- Mutable origin context: bus.subscribe("message:inbound") to update before adapter processes
- onComplete callback creates OutboundMessage and publishes to bus

---

### US-007 - Sub-agent Result Routing & Integration Test (DONE)
**Files modified:**
- packages/core/src/agent/subagent-integration.test.ts (created, 3 tests)

**Learnings:**
- Integration tests replicate gateway's onComplete callback pattern with mock bus
- Result format: "Background task completed/failed:\nTask: ...\nResult/Error: ..."

---
